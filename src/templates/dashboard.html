{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="max-w-3xl mx-auto space-y-8">
  <h1 class="text-3xl font-semibold text-center">Dashboard</h1>
  <form id="job-form" class="space-y-4">
    <input id="prompt" class="w-full px-4 py-2 rounded bg-slate-900 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-teal-500" type="text" placeholder="Enter prompt" required />
    <input id="image-url" class="w-full px-4 py-2 rounded bg-slate-900 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-teal-500" type="text" placeholder="Image URL" required />
    <button class="w-full py-2 rounded bg-teal-500 hover:bg-teal-400 text-slate-900 font-semibold" type="submit">Submit</button>
  </form>
  <table class="min-w-full text-sm" id="jobs-table">
    <thead>
      <tr class="text-left">
        <th class="px-2 py-1">ID</th>
        <th class="px-2 py-1">Prompt</th>
        <th class="px-2 py-1">Status</th>
        <th class="px-2 py-1">Submitted</th>
        <th class="px-2 py-1">Video</th>
      </tr>
    </thead>
    <tbody id="jobs-body"></tbody>
  </table>
</div>
<script>
const USER_ID = {{ user_id | tojson }};
async function loadJobs() {
  const res = await fetch(`/list_jobs/${USER_ID}`);
  const jobs = await res.json();
  const body = document.getElementById('jobs-body');
  body.innerHTML = '';
  jobs.forEach(job => {
    const tr = document.createElement('tr');
    let videoLinks = '';
    if (job.video_url) {
      videoLinks = `<a href="${job.video_url}" target="_blank" class="text-teal-400">View</a>` +
                   ` <a href="${job.video_url}" download class="text-teal-400 ml-2">Download</a>`;
    }
    tr.innerHTML = `<td class="px-2 py-1">${job.id}</td>`+
                   `<td class="px-2 py-1">${job.prompt}</td>`+
                   `<td class="px-2 py-1">${job.status}</td>`+
                   `<td class="px-2 py-1">${job.submitted_at}</td>`+
                   `<td class="px-2 py-1">${videoLinks}</td>`;
    body.appendChild(tr);
  });
}

document.getElementById('job-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const prompt = document.getElementById('prompt').value;
  const imageUrl = document.getElementById('image-url').value;
  await fetch('/submit_job', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ user_id: USER_ID, prompt, params: { image_url: imageUrl } })
  });
  loadJobs();
});

document.addEventListener('DOMContentLoaded', loadJobs);
</script>
{% endblock %}
