{% extends 'base.html' %}
{% block title %}Admin Dashboard{% endblock %}
{% block content %}
<div class="space-y-8">
  <h1 class="text-3xl font-semibold text-center">Admin Dashboard</h1>
  <div class="text-right">
    <button id="refresh-admin" class="px-4 py-2 rounded bg-teal-500 hover:bg-teal-400 text-slate-900 font-semibold">Refresh Data</button>
  </div>
  <section>
    <h2 class="text-xl font-semibold mb-2">Jobs</h2>
    <table class="min-w-full text-sm" id="admin-jobs-table">
      <thead>
        <tr class="text-left">
          <th class="px-2 py-1">ID</th>
          <th class="px-2 py-1">User</th>
          <th class="px-2 py-1">Prompt</th>
          <th class="px-2 py-1">Status</th>
          <th class="px-2 py-1">Submitted</th>
          <th class="px-2 py-1">Video</th>
        </tr>
      </thead>
      <tbody id="admin-jobs-body"></tbody>
    </table>
  </section>
  <section>
    <h2 class="text-xl font-semibold mb-2">KPIs quotidiens</h2>
    <canvas id="kpi-chart" class="w-full h-64"></canvas>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm mt-4">
        <thead>
          <tr class="text-left">
            <th class="px-2 py-1">Jour</th>
            <th class="px-2 py-1">Jobs totaux</th>
            <th class="px-2 py-1">Réussis</th>
            <th class="px-2 py-1">Échecs</th>
            <th class="px-2 py-1">Utilisateurs actifs</th>
            <th class="px-2 py-1">Durée moyenne (s)</th>
            <th class="px-2 py-1">Durée médiane (s)</th>
            <th class="px-2 py-1">Taux de réussite (%)</th>
            <th class="px-2 py-1">Mise à jour</th>
          </tr>
        </thead>
        <tbody id="kpi-body"></tbody>
      </table>
    </div>
  </section>
  <section>
    <h2 class="text-xl font-semibold mb-2">Users</h2>
    <table class="min-w-full text-sm" id="admin-users-table">
      <thead>
        <tr class="text-left">
          <th class="px-2 py-1">User ID</th>
          <th class="px-2 py-1">Role</th>
          <th class="px-2 py-1">GPU Minutes</th>
        </tr>
      </thead>
      <tbody id="admin-users-body"></tbody>
    </table>
  </section>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let kpiChart;

async function loadAdmin() {
  const jobsRes = await fetch('/admin/list_jobs');
  const jobs = await jobsRes.json();
  const jobsBody = document.getElementById('admin-jobs-body');
  jobsBody.innerHTML = '';
  jobs.forEach(j => {
    let videoLinks = '';
    if (j.video_url) {
      videoLinks = `<a href="${j.video_url}" target="_blank" class="text-teal-400">View</a>` +
                   ` <a href="${j.video_url}" download class="text-teal-400 ml-2">Download</a>`;
    }
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="px-2 py-1">${j.id}</td>`+
                   `<td class="px-2 py-1">${j.user_id}</td>`+
                   `<td class="px-2 py-1">${j.prompt}</td>`+
                   `<td class="px-2 py-1">${j.status}</td>`+
                   `<td class="px-2 py-1">${j.submitted_at}</td>`+
                   `<td class="px-2 py-1">${videoLinks}</td>`;
    jobsBody.appendChild(tr);
  });

  const usersRes = await fetch('/admin/list_users');
  const users = await usersRes.json();
  const usersBody = document.getElementById('admin-users-body');
  usersBody.innerHTML = '';
  users.forEach(u => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="px-2 py-1">${u.user_id}</td>`+
                   `<td class="px-2 py-1">${u.role}</td>`+
                   `<td class="px-2 py-1">${u.gpu_minutes_quota}</td>`;
    usersBody.appendChild(tr);
  });

  const kpiRes = await fetch('/admin/kpis');
  const kpis = await kpiRes.json();
  const kpiBody = document.getElementById('kpi-body');
  kpiBody.innerHTML = '';

  if (!Array.isArray(kpis)) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="px-2 py-1" colspan="9">${kpis.error || 'Impossible de charger les KPIs.'}</td>`;
    kpiBody.appendChild(tr);
  } else if (kpis.length === 0) {
    const tr = document.createElement('tr');
    tr.innerHTML = '<td class="px-2 py-1" colspan="9">Aucune donnée KPI disponible.</td>';
    kpiBody.appendChild(tr);
  } else {
    const labels = [];
    const totalData = [];
    const successData = [];
    const failedData = [];
    const successRateData = [];
    const ordered = [...kpis].reverse();

    ordered.forEach(k => {
      const total = Number(k.jobs_total ?? 0);
      const succeeded = Number(k.jobs_succeeded ?? 0);
      const failed = Number(k.jobs_failed ?? 0);
      const activeUsers = Number(k.active_users ?? 0);
      const avgValue = Number(k.avg_duration_seconds);
      const avgDuration = Number.isFinite(avgValue) ? avgValue.toFixed(1) : '—';
      const medianValue = Number(k.p50_duration_seconds);
      const medianDuration = Number.isFinite(medianValue) ? medianValue.toFixed(1) : '—';
      const successRatioRaw = k.success_rate;
      const successRatio = successRatioRaw != null ? Number(successRatioRaw) : null;
      const successPct = successRatio != null && !Number.isNaN(successRatio) ? successRatio * 100 : null;
      const successDisplay = successPct != null ? successPct.toFixed(1) : '—';
      const updated = k.updated_at ? new Date(k.updated_at).toLocaleString() : '—';

      labels.push(k.day ?? '');
      totalData.push(total);
      successData.push(succeeded);
      failedData.push(failed);
      successRateData.push(successPct != null ? Number(successPct.toFixed(1)) : null);

      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="px-2 py-1">${k.day ?? ''}</td>`+
                     `<td class="px-2 py-1">${total}</td>`+
                     `<td class="px-2 py-1">${succeeded}</td>`+
                     `<td class="px-2 py-1">${failed}</td>`+
                     `<td class="px-2 py-1">${activeUsers}</td>`+
                     `<td class="px-2 py-1">${avgDuration}</td>`+
                     `<td class="px-2 py-1">${medianDuration}</td>`+
                     `<td class="px-2 py-1">${successDisplay !== '—' ? successDisplay + '%' : '—'}</td>`+
                     `<td class="px-2 py-1">${updated}</td>`;
      kpiBody.appendChild(tr);
    });

    const ctx = document.getElementById('kpi-chart');
    if (kpiChart) {
      kpiChart.destroy();
    }
    kpiChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          { label: 'Jobs totaux', data: totalData, borderColor: 'teal', tension: 0.3, yAxisID: 'y' },
          { label: 'Jobs réussis', data: successData, borderColor: 'rgb(56,189,248)', tension: 0.3, yAxisID: 'y' },
          { label: 'Jobs échoués', data: failedData, borderColor: 'rgb(248,113,113)', tension: 0.3, yAxisID: 'y' },
          { label: 'Taux de réussite (%)', data: successRateData, borderColor: 'orange', borderDash: [5, 5], tension: 0.3, yAxisID: 'y1' }
        ]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: 'Jobs' }
          },
          y1: {
            beginAtZero: true,
            position: 'right',
            suggestedMax: 100,
            title: { display: true, text: 'Taux (%)' },
            grid: { drawOnChartArea: false }
          }
        }
      }
    });
  }
}

document.addEventListener('DOMContentLoaded', loadAdmin);

document.getElementById('refresh-admin').addEventListener('click', loadAdmin);
</script>
{% endblock %}
