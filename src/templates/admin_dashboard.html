{% extends 'base.html' %}
{% block title %}Admin Dashboard{% endblock %}
{% block content %}
<div class="space-y-8">
  <h1 class="text-3xl font-semibold text-center">Admin Dashboard</h1>
  <section>
    <h2 class="text-xl font-semibold mb-2">Jobs</h2>
    <table class="min-w-full text-sm" id="admin-jobs-table">
      <thead>
        <tr class="text-left">
          <th class="px-2 py-1">ID</th>
          <th class="px-2 py-1">User</th>
          <th class="px-2 py-1">Prompt</th>
          <th class="px-2 py-1">Status</th>
          <th class="px-2 py-1">Submitted</th>
          <th class="px-2 py-1">Video</th>
        </tr>
      </thead>
      <tbody id="admin-jobs-body"></tbody>
    </table>
  </section>
  <section>
    <h2 class="text-xl font-semibold mb-2">KPIs quotidiens</h2>
    <canvas id="kpi-chart" class="w-full h-64"></canvas>
    <table class="min-w-full text-sm mt-4">
      <thead>
        <tr class="text-left">
          <th class="px-2 py-1">Jour</th>
          <th class="px-2 py-1">Jobs</th>
          <th class="px-2 py-1">GPU min</th>
          <th class="px-2 py-1">Coût (cents)</th>
        </tr>
      </thead>
      <tbody id="kpi-body"></tbody>
    </table>
  </section>
  <section>
    <h2 class="text-xl font-semibold mb-2">Users</h2>
    <table class="min-w-full text-sm" id="admin-users-table">
      <thead>
        <tr class="text-left">
          <th class="px-2 py-1">User ID</th>
          <th class="px-2 py-1">Role</th>
          <th class="px-2 py-1">GPU Minutes</th>
        </tr>
      </thead>
      <tbody id="admin-users-body"></tbody>
    </table>
  </section>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function loadAdmin() {
  try {
    const jobsRes = await fetch('/admin/list_jobs');
    if (!jobsRes.ok) {
      const text = await jobsRes.text();
      alert(`Erreur chargement jobs: ${text}`);
      return;
    }
    const jobs = await jobsRes.json();
    const jobsBody = document.getElementById('admin-jobs-body');
    jobsBody.innerHTML = '';
    jobs.forEach(j => {
      let videoLinks = '';
      if (j.video_url) {
        videoLinks = `<a href="${j.video_url}" target="_blank" class="text-teal-400">View</a>`;
      }
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="px-2 py-1">${j.id}</td>`+
                     `<td class="px-2 py-1">${j.user_id}</td>`+
                     `<td class="px-2 py-1">${j.prompt}</td>`+
                     `<td class="px-2 py-1">${j.status}</td>`+
                     `<td class="px-2 py-1">${j.submitted_at}</td>`+
                     `<td class="px-2 py-1">${videoLinks}</td>`;
      jobsBody.appendChild(tr);
    });

    const usersRes = await fetch('/admin/list_users');
    if (!usersRes.ok) {
      const text = await usersRes.text();
      alert(`Erreur chargement utilisateurs: ${text}`);
      return;
    }
    const users = await usersRes.json();
    const usersBody = document.getElementById('admin-users-body');
    usersBody.innerHTML = '';
    users.forEach(u => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="px-2 py-1">${u.user_id}</td>`+
                     `<td class="px-2 py-1">${u.role}</td>`+
                     `<td class="px-2 py-1">${u.gpu_minutes_quota}</td>`;
      usersBody.appendChild(tr);
    });

    const kpiRes = await fetch('/admin/kpis');
    if (!kpiRes.ok) {
      const text = await kpiRes.text();
      alert(`Erreur chargement KPIs: ${text}`);
      return;
    }
    const kpis = await kpiRes.json();
    const kpiBody = document.getElementById('kpi-body');
    kpiBody.innerHTML = '';
    const labels = [];
    const jobsData = [];
    const gpuData = [];
    const costData = [];
    kpis.reverse().forEach(k => {
      labels.push(k.day);
      jobsData.push(k.jobs);
      gpuData.push(k.gpu_minutes);
      costData.push(k.cost_cents);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="px-2 py-1">${k.day}</td>`+
                     `<td class="px-2 py-1">${k.jobs}</td>`+
                     `<td class="px-2 py-1">${k.gpu_minutes}</td>`+
                     `<td class="px-2 py-1">${k.cost_cents}</td>`;
      kpiBody.appendChild(tr);
    });
    const ctx = document.getElementById('kpi-chart');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          { label: 'Jobs', data: jobsData, borderColor: 'teal', tension: 0.3 },
          { label: 'GPU min', data: gpuData, borderColor: 'orange', tension: 0.3 },
          { label: 'Coût (cents)', data: costData, borderColor: 'purple', tension: 0.3 }
        ]
      }
    });
  } catch (err) {
    alert(`Erreur tableau admin: ${err}`);
  }
}

document.addEventListener('DOMContentLoaded', loadAdmin);
</script>
{% endblock %}
